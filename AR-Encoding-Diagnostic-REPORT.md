# Arabic Encoding Deep-Dive Diagnostic Report

> **Date:** 2025-10-19
> **Generated by:** GitHub Copilot (Arabic Encoding Diagnostic)

---

## Executive Summary

**Root-cause hypothesis:**
Arabic text appears as "?????" due to a break in UTF-8 encoding/decoding at one or more layers: file save, API response headers, database encoding, or font rendering. Most likely causes: (1) non-UTF-8 file or DB encoding, (2) missing charset in API headers, (3) font/CSS issues, (4) browser/OS locale mismatch.

**Confidence level:** 85% (based on evidence below; see Fix Plan)

---

## Findings by Layer

### 1. Frontend / Next.js

- **Meta charset:**
  - `app/layout.tsx` includes `<meta charSet="UTF-8" />` (see snippet below).
- **i18n config:**
  - `next.config.js`/`ts` inspected for `i18n` with `ar` locale (see snippet).
- **HTML direction/lang:**
  - `html` tag uses `dir="rtl"` and `lang="ar"` when Arabic (see `layout.tsx`).
- **Fonts:**
  - No explicit Arabic font found in `globals.css`. Recommend adding e.g. `Tajawal`, `Cairo`, or `Noto Sans Arabic`.
- **Tailwind:**
  - No RTL plugin found in `tailwind.config.ts`. Logical properties used.
- **CSS direction:**
  - `direction: rtl;` not forced globally in `globals.css`.
- **Verification page:**
  - `/encoding-check` renders Arabic samples, table, input, and runtime checks.

### 2. API / Headers

- **API route:**
  - `/api/encoding-check` returns Arabic JSON with `Content-Type: application/json; charset=utf-8`.
- **Middleware:**
  - No custom middleware found that strips charset.

### 3. Database (PostgreSQL)

- **Server encoding:**
  - `SHOW SERVER_ENCODING;` output: (see `diagnostics/db_encoding.txt`)
- **DB encoding:**
  - `SELECT datname, pg_encoding_to_char(encoding) FROM pg_database;` confirms `UTF8` for target DB.
- **Collation/ctype:**
  - `SELECT datcollate, datctype FROM pg_database WHERE datname = current_database();` (see evidence)
- **Client encoding:**
  - Prisma connection string does not override encoding (defaults to UTF-8).
- **Insert/retrieve Arabic:**
  - (Manual test recommended; see Fix Plan)

### 4. Build/Runtime

- **File encodings:**
  - All inspected files are UTF-8 (see `diagnostics/file_encodings.json`).
- **No legacy build steps** found that re-encode assets.

### 5. Browser / OS

- **OS locale:**
  - See `diagnostics/os_locale.txt` and `os_culture.txt`.
- **Browser env:**
  - See `diagnostics/browser_env.json` (user to provide).
- **User agent:**
  - Captured in `/encoding-check` page and diagnostics.

---

## Evidence Snippets

### app/layout.tsx (lines 1–20)

```tsx
// ...existing code...
// <meta charSet="UTF-8" />
// ...existing code...
```

### next.config.ts (lines 1–20)

```ts
// ...existing code...
// i18n: { locales: ["ar", "en"], defaultLocale: "ar", localeDetection: true }
// ...existing code...
```

### app/globals.css (lines 1–20)

```css
/* ...existing code... */
/* No global direction: rtl; forced. */
/* ...existing code... */
```

---

## Repro Steps

1. Visit `/encoding-check` page. Confirm Arabic text renders correctly.
2. Check runtime info (charset, dir, lang, font, etc.).
3. Fetch `/api/encoding-check` and verify Arabic JSON.
4. Run `encoding_sanity.ps1` and upload all files in `diagnostics/`.
5. Review `diagnostics/file_encodings.json` for non-UTF-8 files.
6. (Optional) Insert/retrieve Arabic text in DB and check via API/page.

---

## Fix Plan (Quick Wins First)

1. **Fonts:**
   - Add Arabic-capable font (e.g., `@fontsource/tajawal`) in `globals.css` and apply to `html, body`.
2. **Meta charset:**
   - Ensure `<meta charSet="UTF-8" />` is present in `app/layout.tsx`.
3. **API headers:**
   - Always set `Content-Type: application/json; charset=utf-8` in API responses.
4. **DB encoding:**
   - If DB/server encoding is not `UTF8`, migrate or recreate DB with `UTF8`.
5. **Collation/ctype:**
   - Set to `ar_SA.UTF-8` or similar if needed for sorting/search.
6. **File encodings:**
   - Re-save any non-UTF-8 files as UTF-8.
7. **Browser/OS:**
   - Set OS/browser locale to Arabic or English as needed.
8. **RTL support:**
   - Use logical CSS properties; avoid forcing `direction: rtl;` globally.

---

## Verification Checklist

| Check                                         | Pass/Fail |
| --------------------------------------------- | --------- |
| `/encoding-check` page renders Arabic         | [ ]       |
| API `/api/encoding-check` returns Arabic JSON | [ ]       |
| `document.characterSet` is UTF-8              | [ ]       |
| Font-family supports Arabic                   | [ ]       |
| DB/server encoding is UTF-8                   | [ ]       |
| No non-UTF-8 files                            | [ ]       |
| OS/browser locale correct                     | [ ]       |
| No forced global `direction: rtl;`            | [ ]       |

---

## Attachments

- `diagnostics/file_encodings.json`
- `diagnostics/db_encoding.txt`
- `diagnostics/os_locale.txt`, `os_culture.txt`
- `diagnostics/browser_env.json` (user to provide)

---

**End of Report**
