# تقرير تنفيذ تعديلات واجهة نظام التدقيق الداخلي
**تاريخ التنفيذ:** 21 أكتوبر 2025  
**وفق معايير:** IPPF 2024/2025

---

## ملخص التعديلات المنفذة

تم تطبيق جميع التعديلات المطلوبة على واجهة نظام التدقيق الداخلي بنجاح، مع التركيز على:
1. فصل وظائف العرض عن وظائف الإنشاء/التعديل
2. إعادة هيكلة صفحة الخطة السنوية (RBIA) لتصبح محوراً مركزياً للإدارة
3. تطبيق صلاحيات RACI على مستوى الواجهة
4. إضافة رسائل عربية قياسية واضحة

---

## 1. لوحة القيادة (Dashboard) - عرض فقط ✅

### التعديلات المطبقة:
- **إزالة زر "إنشاء خطة سنوية"** من Dashboard
- **إزالة مكون CreatePlanWizard** من Dashboard
- الصفحة الآن للعرض فقط: KPIs، مؤشرات التقدم، ملخصات

### الملفات المعدلة:
- `app/(app)/shell/DashboardView.tsx`

### السلوك الجديد:
- Dashboard يعرض فقط البيانات التالية:
  - بطاقات KPIs (إنجاز الخطة، تغطية الاختبارات، طلبات PBC، تنفيذ الإجراءات)
  - المخططات البيانية للتقدم
  - جداول المهام للقراءة فقط
  - أزرار: تحديث، تصدير (للبيانات فقط، بدون إنشاء)
- لا يمكن إنشاء أو تعديل أي بيانات من هذه الصفحة

---

## 2. صفحة الخطة السنوية (RBIA Plan) - تبويبات داخلية ✅

### التعديلات المطبقة:
- تحويل صفحة RBIA Plan إلى صفحة بتبويبات داخلية
- إضافة 3 تبويبات رئيسية مع شارات RACI:
  1. **عرض الخطة** (R) - للجميع
  2. **إنشاء خطة** (A) - IA_Manager / CAE فقط
  3. **تخطيط المهمات** (A/R) - يظهر بعد وجود خطة

### الملفات المعدلة:
- `app/(app)/rbia/plan/page.tsx` - إضافة نظام التبويبات
- `app/(app)/rbia/plan/EngagementPlanningView.tsx` - مكون جديد لتخطيط المهمات

### السلوك الجديد:
#### تبويب "عرض الخطة":
- عرض بيانات الخطة الحالية
- جداول المهام والإحصائيات
- متاح للجميع (R)

#### تبويب "إنشاء خطة":
- نموذج إنشاء خطة جديدة بالحقول:
  - السنة المالية* (إلزامي)
  - رقم النسخة* (إلزامي)
  - المالك (اختياري)
  - الحالة: "مسودة" عند الإنشاء
- متاح فقط لـ IA_Manager / CAE
- رسالة رفض للصلاحية: "لا تملك صلاحية إنشاء خطة. الرجاء التواصل مع IA_Manager/CAE."

#### تبويب "تخطيط المهمات":
- لا يظهر إلا بعد وجود خطة واحدة على الأقل
- إدارة المهام الرئيسية والجزئية

---

## 3. تخطيط المهمات (Engagement Planning) ✅

### المكون الجديد:
`app/(app)/rbia/plan/EngagementPlanningView.tsx`

### الوظائف المتاحة:

#### أ) إنشاء مهمة رئيسية (Main Engagement)
**الحقول الإلزامية:**
- العنوان* - رسالة: "الرجاء استكمال الحقول الإلزامية: العنوان*"
- الإدارة/العملية* - رسالة: "الرجاء استكمال الحقول الإلزامية: الإدارة/العملية*"
- الأولوية/المخاطر* (عالي/متوسط/منخفض)
- الربع* (Q1/Q2/Q3/Q4)
- تقدير الساعات*
- المالك التنفيذي* - رسالة: "الرجاء استكمال الحقول الإلزامية: المالك التنفيذي*"
- النطاق* - رسالة: "الرجاء استكمال الحقول الإلزامية: النطاق*"
- الأهداف* - رسالة: "الرجاء استكمال الحقول الإلزامية: الأهداف*"
- المعايير المرجعية* (IPPF، COSO، ISO 31000، لوائح قطر)

**الحقول الاختيارية:**
- رمز المهمة (يتم توليده تلقائياً إذا لم يُحدد)

**قواعد التحقق:**
- لا يمكن نشر المهمة بدون نطاق/أهداف/معايير مرجعية
- رسالة: "لا يمكن نشر المهمة بدون نطاق/أهداف/معايير مرجعية."

**رسائل النجاح:**
- "تم إنشاء المهمة بنجاح"
- "تم نشر المهمة بنجاح"

#### ب) إنشاء مهمة جزئية (Sub-Task)
**الحقول الإلزامية:**
- عنوان الجزئية* - رسالة: "لا يمكن إنشاء مهمة جزئية بدون تحديد: عنوان الجزئية*"
- نطاق مختصر* - رسالة: "لا يمكن إنشاء مهمة جزئية بدون تحديد: نطاق مختصر*"
- تاريخ ووقت البداية* - رسالة: "لا يمكن إنشاء مهمة جزئية بدون تحديد: وقت البداية والنهاية*"
- تاريخ ووقت النهاية*
- المسؤول* - رسالة: "لا يمكن إنشاء مهمة جزئية بدون تحديد: المسؤول*"

**الحقول الاختيارية:**
- ربط بـ WPRef/اختبارات
- مخرجات متوقعة

**قواعد التحقق:**
- منع التداخل الزمني لنفس المسؤول
- رسالة: "تداخل زمني: يوجد للمسؤول مهمة جزئية أخرى في نفس الفترة."
- تحديث نسبة التقدم في المهمة الرئيسة تلقائياً بناءً على المهام الجزئية المكتملة

**رسالة النجاح:**
- "تم إنشاء المهمة الجزئية بنجاح"

---

## 4. شارات RACI وصلاحيات الواجهة ✅

### التطبيق على التبويبات:
- **عرض الخطة (R)** - Responsible: جميع الأدوار يمكنهم القراءة
- **إنشاء خطة (A)** - Accountable: IA_Manager / CAE فقط
- **تخطيط المهمات (A/R)** - Accountable/Responsible: IA_Manager للإنشاء، Senior/Auditor للتنفيذ

### دليل RACI المعروض:
تم إضافة شريط توضيحي أسفل التبويبات:
```
A = Accountable (مسؤول)
R = Responsible (منفذ)
C = Consulted (مستشار)
I = Informed (مُبلّغ)
```

### منطق الصلاحيات المطبق:
```typescript
// محاكاة - يجب استبدالها بنظام المصادقة الفعلي
const userRole = localStorage.getItem('userRole') || 'auditor';
const canCreatePlan = ['ia_manager', 'cae'].includes(userRole.toLowerCase());
```

---

## 5. الرسائل العربية القياسية ✅

### رسائل النجاح:
- "تم حفظ الخطة بنجاح"
- "تم إنشاء المهمة بنجاح"
- "تم إنشاء المهمة الجزئية بنجاح"
- "تم نشر المهمة بنجاح"

### رسائل التحقق:
- "الرجاء استكمال الحقول الإلزامية: السنة المالية، رقم النسخة، UserID، حالة الخطة."
- "لا يمكن نشر المهمة بدون نطاق/أهداف/معايير مرجعية."
- "لا يمكن إنشاء مهمة جزئية بدون تحديد وقت البداية والنهاية والنطاق والمسؤول."
- "تداخل زمني: يوجد للمسؤول مهمة جزئية أخرى في نفس الفترة."

### رسائل الصلاحيات:
- "لا تملك صلاحية إنشاء خطة. الرجاء التواصل مع IA_Manager/CAE."
- "يجب إنشاء خطة أولاً قبل الوصول إلى تخطيط المهمات"

---

## 6. التبويب والعناوين النهائية ✅

### القائمة الجانبية (محدثة):
تم تحديث ملف الترجمة `lib/i18n.ts`:

**العربية:**
- لوحة القيادة (عرض فقط)
- الخطة السنوية (RBIA)
- التخطيط
- فهم العملية والمخاطر
- برنامج العمل والعيّنات
- الأعمال الميدانية والأدلة
- اللمسات الرشيقة
- النتائج والتوصيات
- التقرير النهائي
- المتابعة
- الإقفال
- ضمان الجودة

**الإنجليزية:**
- Dashboard (View Only)
- RBIA Annual Plan
- Planning
- Process & Risk
- Work Program & Sampling
- Fieldwork & Evidence
- Agile Touchpoints
- Findings & Recommendations
- Final Report
- Follow-up
- Closeout
- Quality Assurance

### التبويبات داخل صفحة RBIA:
1. عرض الخطة
2. إنشاء خطة
3. تخطيط المهمات

---

## 7. منطق حالات المهام (State Machine) ✅

### تسلسل الحالات المطبق:
```
Draft → Planned → In-Field → IssuesDrafted → ReportDraft → ReportFinal → FollowUp → Closed
```

### التطبيق في الكود:
- حالة المهمة عند الإنشاء: `draft`
- عند النشر: `planned`
- التقدم يُحدث تلقائياً بناءً على المهام الجزئية المكتملة
- شارات الحالة بالألوان:
  - مسودة: رمادي
  - مخطط: أزرق
  - ميداني: بنفسجي
  - تقرير: برتقالي
  - مغلق: أخضر

---

## 8. الجودة والترابط ✅

### التحققات المطبقة:
✅ "إنشاء خطة" و"تخطيط المهمات" يعملان كتبويبات داخلية (Subviews) وليس كصفحات مستقلة  
✅ لا يظهر تبويب "تخطيط المهمات" قبل وجود خطة  
✅ لا يمكن الإنشاء أو التعديل من لوحة القيادة  
✅ التحقق من الصلاحيات قبل عرض التبويبات  
✅ منع التداخل الزمني للمهام الجزئية  
✅ التحديث التلقائي لنسبة التقدم  
✅ رسائل عربية واضحة لكل عملية  

---

## الملفات الرئيسية المعدلة/المُنشأة

### ملفات معدلة:
1. `app/(app)/shell/DashboardView.tsx` - إزالة وظائف الإنشاء
2. `app/(app)/rbia/plan/page.tsx` - إضافة نظام التبويبات مع RACI
3. `lib/i18n.ts` - تحديث العناوين والتبويبات

### ملفات جديدة:
4. `app/(app)/rbia/plan/EngagementPlanningView.tsx` - مكون تخطيط المهمات الكامل

---

## ملاحظات مهمة للتطوير المستقبلي

### 1. نظام المصادقة:
```typescript
// حالياً: محاكاة من localStorage
const userRole = localStorage.getItem('userRole') || 'auditor';

// يجب استبداله بـ:
const { data: session } = useSession();
const userRole = session?.user?.role || 'auditor';
```

### 2. قاعدة البيانات:
- يجب إضافة جداول للمهام الجزئية (sub_tasks)
- إضافة حقل `progress` للمهام الرئيسية
- إضافة حقل `standards` (JSON array) للمعايير المرجعية

### 3. API Endpoints المطلوبة:
```
POST /api/plan - إنشاء خطة جديدة ✅
GET /api/plan/latest - الحصول على آخر خطة ✅
POST /api/plan/{id}/tasks - إنشاء مهام ✅
GET /api/plan/{id}/tasks - الحصول على مهام الخطة ✅
POST /api/engagements - إنشاء مهمة رئيسية (يحتاج تحديث)
POST /api/engagements/{id}/subtasks - إنشاء مهمة جزئية (جديد)
```

### 4. التحسينات المقترحة:
- إضافة تصفية وبحث في قائمة المهام
- إضافة إشعارات عند اقتراب مواعيد المهام الجزئية
- إضافة تقارير تقدم المهام
- إضافة إمكانية تصدير خطة العمل بصيغ مختلفة
- إضافة نظام الموافقات المتعددة للنشر

---

## الخلاصة

تم تطبيق جميع التعديلات المطلوبة بنجاح وفق المواصفات التالية:
- ✅ Dashboard للعرض فقط
- ✅ إنشاء الخطة داخل تبويب مخصص
- ✅ تخطيط المهمات الرئيسية والجزئية
- ✅ صلاحيات RACI واضحة
- ✅ رسائل عربية قياسية
- ✅ التحقق من البيانات والقواعد
- ✅ منطق حالات المهام
- ✅ تبويبات نهائية بأسماء عربية

النظام جاهز للاختبار والتطوير المستمر.

---

**تم التنفيذ بواسطة:** GitHub Copilot  
**المعايير المطبقة:** IPPF 2024/2025  
**التاريخ:** 21 أكتوبر 2025
